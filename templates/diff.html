{% extends "layout.html" %}

{% block title %}{{ commit_hash[:7] }} · {{ repo_name }}{% endblock %}

{% block content %}
<div class="diff-header-container">
    <div class="diff-title">
        仓库更新内容
        <span class="diff-commit-hash">#{{ commit_hash[:7] }}</span>
    </div>
    <div class="diff-meta">
        <span class="diff-author">Olsc</span> 提交于不久前
    </div>
</div>

<div class="Box">
    <div class="Box-header">
        <span style="font-family: monospace;">文件变更情况</span>
    </div>
    <div style="border-top: 1px solid var(--color-border-default); background: var(--color-canvas-default);">
        <div id="diff-content" style="margin: 0; overflow: auto; font-family: monospace; font-size: 12px;"></div>
    </div>
</div>

<script>
    
    const diffText = {{ diff| tojson }};
    const lines = diffText.split('\n');
    let html = '';

    lines.forEach(line => {
        let lineClass = 'diff-line';
        if (line.startsWith('+')) {
            lineClass += ' diff-line-add';
        } else if (line.startsWith('-')) {
            lineClass += ' diff-line-del';
        } else if (line.startsWith('@@')) {
            lineClass += ' diff-line-meta';
        } else if (line.startsWith('diff') || line.startsWith('index') || line.startsWith('---') || line.startsWith('+++')) {
            lineClass += ' diff-line-info';
        }

        const escapedLine = line
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/ /g, '&nbsp;');

        html += `<div class="${lineClass}">${escapedLine || '&nbsp;'}</div>`;
    });

    document.getElementById('diff-content').innerHTML = html;
</script>
{% endblock %}